@model SantaFeWaterSystem.ViewModels.UserProfileViewModel

@{
    ViewData["Title"] = "Profile";
    Layout = "~/Views/Shared/_HomeLayout.cshtml";
}

@section Styles {
    <link href="~/css/profile.css" rel="stylesheet" asp-append-version="true" />
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 text-primary fw-bold">
        <i class="bi bi-person-circle me-2"></i> My Profile
    </h2>
    <a href="@Url.Action("Dashboard", "User")"
       class="btn btn-danger btn-sm rounded-circle d-flex align-items-center justify-content-center"
       style="width: 32px; height: 32px;"
       title="Back">
        <i class="bi bi-x-lg text-white"></i>
    </a>
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>@TempData["Message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="card shadow-sm rounded-3 p-3 mx-auto profile-container">
    <div class="text-center mb-3">
        <img id="previewImage"
             src="~/images/profiles/@(Model.ExistingProfilePicture ?? "default.png")"
             class="rounded-circle shadow-sm mb-3"
             loading="lazy"
             style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #fff; box-shadow: 0 0 10px rgba(0,123,255,0.5); cursor: pointer;"
             alt="Profile Picture"
             data-bs-toggle="modal"
             data-bs-target="#profilePreviewModal" />
        <h5 class="fw-bold">@Model.FullName</h5>
    </div>

    <div class="row g-2">
        <div class="col-12 col-sm-6">
            <label class="form-label"><i class="bi bi-geo-alt-fill text-primary fs-5"></i> Address</label>
            <input class="form-control form-control-sm bg-secondary text-white" value="@Model.Address" readonly />
        </div>

        <div class="col-12 col-sm-6">
            <label class="form-label"><i class="bi bi-telephone-fill text-primary fs-5"></i> Contact Number</label>
            <input class="form-control form-control-sm bg-secondary text-white" value="@Model.ContactNumber" readonly />
        </div>

        <div class="col-12 col-sm-6">
            <label class="form-label"><i class="bi bi-envelope-fill text-primary fs-5"></i> Email</label>
            <input class="form-control form-control-sm bg-secondary text-white" value="@Model.Email" readonly />
        </div>

        <div class="col-12 col-sm-4">
            <label class="form-label"><i class="bi bi-credit-card-2-front-fill text-primary fs-5"></i> Account Number</label>
            <input class="form-control form-control-sm bg-secondary text-white" value="@Model.AccountNumber" readonly />
        </div>

        <div class="col-12 col-sm-4">
            <label class="form-label"><i class="bi bi-card-list text-primary fs-5"></i> Account Type</label>
            <input class="form-control form-control-sm bg-secondary text-white" value="@Model.AccountType" readonly />
        </div>

        <div class="col-12 col-sm-4">
            <label class="form-label"><i class="bi bi-speedometer2 text-primary fs-5"></i> Meter No.</label>
            <input class="form-control form-control-sm bg-secondary text-white" value="@Model.MeterNo" readonly />
        </div>
    </div>

    <div class="text-center mt-3">
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
            <i class="bi bi-pencil-square me-1"></i> Edit Profile
        </button>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Profile" method="post" enctype="multipart/form-data" novalidate>
                    <input type="hidden" asp-for="Id" />
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

                    <div class="mb-3 text-center">
                        <img id="modalProfileImage"
                             src="~/images/profiles/@(Model.ExistingProfilePicture ?? "default.png")"
                             class="rounded-circle shadow-sm mb-2"
                             style="width: 100px; height: 100px; object-fit: cover; cursor:pointer;"
                             alt="Profile Picture" />

                        <div class="d-flex justify-content-center gap-2 mt-2">
                            <button type="button" class="btn btn-success btn-sm" onclick="document.getElementById('cameraInput').click();">
                                <i class="bi bi-camera me-1"></i> Take Photo
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('galleryInput').click();">
                                <i class="bi bi-image me-1"></i> Choose from Gallery
                            </button>
                        </div>

                        <!-- Hidden file inputs -->
                        <input type="file" id="cameraInput" name="ProfileImage" accept="image/*" capture="environment" class="d-none" />
                        <input type="file" id="galleryInput" name="ProfileImage" accept="image/*" class="d-none" />

                        <span asp-validation-for="ProfileImage" class="text-danger small"></span>
                    </div>

                    <div class="row g-2">
                        <div class="col-12 col-sm-6">
                            <label asp-for="ContactNumber" class="form-label">Contact Number</label>
                            <input asp-for="ContactNumber" class="form-control form-control-sm" />
                            <span asp-validation-for="ContactNumber" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-sm-6">
                            <label asp-for="Email" class="form-label">Email</label>
                            <input asp-for="Email" type="email" class="form-control form-control-sm" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-save2-fill me-1"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Profile Picture Preview Modal -->
<div class="modal fade" id="profilePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 text-center">
                <img id="modalPreviewImage"
                     src=""
                     class="img-fluid rounded shadow"
                     style="max-height: 80vh; object-fit: contain;"
                     alt="Profile Preview" />
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const previewImage = document.getElementById('previewImage');
        const modalPreviewImage = document.getElementById('modalPreviewImage');
        previewImage.addEventListener('click', () => {
            modalPreviewImage.src = previewImage.src;
        });

        const cameraInput = document.getElementById('cameraInput');
        const galleryInput = document.getElementById('galleryInput');
        const modalImage = document.getElementById('modalProfileImage');

        function updatePreview(input) {
            const file = input.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    modalImage.src = e.target.result;
                    previewImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        cameraInput.addEventListener('change', () => updatePreview(cameraInput));
        galleryInput.addEventListener('change', () => updatePreview(galleryInput));
    </script>
}
