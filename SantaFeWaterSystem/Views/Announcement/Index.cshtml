@model IEnumerable<SantaFeWaterSystem.Models.Announcement>
@{
    ViewData["Title"] = "Community Feed";
    Layout = "~/Views/Shared/_HomeLayout.cshtml";

    string dashboardUrl = User.IsInRole("Admin") || User.IsInRole("Staff")
        ? Url.Action("Dashboard", "Admin") ?? "/Admin/Dashboard"
        : Url.Action("Dashboard", "User") ?? "/User/Dashboard";

    int? currentUserId = null;
    var claim = User.FindFirst("UserId")?.Value;
    if (int.TryParse(claim, out int uid))
    {
        currentUserId = uid;
    }

    var vd = new ViewDataDictionary(ViewData);
    vd["CurrentUserId"] = currentUserId;
}

@section Styles {
    <link rel="stylesheet" href="~/css/community-feed.css" />
    <style>
        .card img {
            width: 100%;
            height: auto;
            object-fit: cover;
        }
    </style>
}

<h2 class="text-center mb-4">
    <i class="bi bi-chat-left-text me-2"></i> Community Feed
</h2>

<div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
    <a href="@dashboardUrl" class="btn btn-secondary flex-grow-1 flex-sm-grow-0">
        <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
    </a>

    @if (User.IsInRole("Admin") || User.IsInRole("Staff"))
    {
        <a asp-action="Create" class="btn btn-success flex-grow-1 flex-sm-grow-0">
            <i class="bi bi-plus-circle me-1"></i> Create Announcement
        </a>
    }
</div>

<div class="container-fluid px-3 px-md-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            @foreach (var post in Model ?? Enumerable.Empty<SantaFeWaterSystem.Models.Announcement>())
            {
                <div class="card shadow-sm mb-3" data-announcement-id="@post.Id">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                            <h5>
                                <i class="bi bi-megaphone-fill text-primary"></i> @post.Title
                                @if (!string.IsNullOrEmpty(post.Admin?.Username))
                                {
                                    <span class="badge bg-danger ms-2">Admin</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary ms-2">User</span>
                                }
                            </h5>
                            <small class="text-muted">
                                Posted by @(post.Admin?.Username ?? "Unknown") at
                                @(post.PostedAt?.ToLocalTime().ToString("g") ?? "Unknown")
                            </small>
                        </div>

                        <p>@post.Content</p>
                        @if (!string.IsNullOrEmpty(post.ImagePath))
                        {
                            <img src="@post.ImagePath" class="img-fluid rounded mb-2" />
                        }

                        @if (User.IsInRole("Admin") || User.IsInRole("Staff"))
                        {
                            <div class="mb-2">
                                <a asp-action="EditAnnouncement" asp-route-id="@post.Id" class="btn btn-sm btn-warning me-1 mb-1">
                                    <i class="bi bi-pencil-square"></i> Edit
                                </a>
                                <form asp-action="DeleteAnnouncement" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@post.Id" />
                                    <button type="submit" class="btn btn-sm btn-danger mb-1"
                                            onclick="return confirm('Are you sure you want to delete this announcement?');">
                                        <i class="bi bi-trash-fill"></i> Delete
                                    </button>
                                </form>
                            </div>
                        }

                        <hr />

                        <!-- Add Feedback -->
                        <div class="add-feedback-box mb-3 p-2 border rounded bg-light">
                            <form asp-action="AddFeedback" method="post" enctype="multipart/form-data"
                                  class="d-flex flex-column gap-2 add-feedback-form">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="announcementId" value="@post.Id" />
                                <textarea name="comment" class="form-control rounded-pill px-3"
                                      rows="1" placeholder="Write a feedback..."></textarea>
                                <div class="d-flex flex-wrap gap-2">
                                    <input type="file" name="image" class="form-control form-control-sm" accept="image/*" />
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="bi bi-send-fill"></i> Post
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Feedback List -->
                        <strong><i class="bi bi-chat-dots-fill"></i> Feedback:</strong>
                        <div class="feedback-list" data-announcement-id="@post.Id">
                            @foreach (var f in post.Feedbacks ?? Enumerable.Empty<SantaFeWaterSystem.Models.Feedback>())
                            {
                                <!-- Each feedback item wrapper -->
                                <div class="feedback-item border rounded p-2 mb-2" data-feedback-id="@f.Id">
                                    @await Html.PartialAsync("_FeedbackItem", f, vd)
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        $(function () {
            // Helper: get antiforgery token
            function getToken() {
                return $("input[name='__RequestVerificationToken']").val();
            }

            // LIKE / UNLIKE FEEDBACK
            $(document).on("click", ".feedback-like", function () {
                var btn = $(this);
                var feedbackId = btn.data("feedback-id");

                $.post('@Url.Action("ToggleFeedbackLike", "Announcement")',
                       { feedbackId, __RequestVerificationToken: getToken() })
                    .done(function (data) {
                        if (data.success) {
                            btn.find(".like-count").text(data.likeCount);
                            btn.toggleClass("btn-outline-primary btn-primary", data.liked);
                        } else {
                            alert(data.message || "Unable to update like status.");
                        }
                    })
                    .fail(() => alert("Error: Could not update like status."));
            });

            // ADD FEEDBACK (with optional image)
            $(document).on("submit", ".add-feedback-form", function (e) {
                e.preventDefault();
                var form = $(this);
                var formData = new FormData(this);
                formData.append("__RequestVerificationToken", getToken());
                var feedbackList = form.closest(".card").find(".feedback-list");

                $.ajax({
                    url: '@Url.Action("AddFeedback", "Announcement")',
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false
                })
                .done(function (feedbackHtml) {
                    feedbackList.prepend(feedbackHtml);
                    form[0].reset();
                })
                .fail(() => alert("Error: Could not submit feedback."));
            });

            // ADD COMMENT
            $(document).on("submit", ".add-comment-form", function (e) {
                e.preventDefault();
                var form = $(this);
                var feedbackId = form.find("input[name='feedbackId']").val();
                var content = form.find("input[name='content']").val();
                if (!content) return;

                $.post('@Url.Action("AddFeedbackComment", "Announcement")',
                       { feedbackId, content, __RequestVerificationToken: getToken() })
                    .done(function (commentHtml) {
                        form.closest(".feedback-comments").prepend(commentHtml);
                        form[0].reset();
                    })
                    .fail(() => alert("Error: Could not add comment."));
            });

            // DELETE FEEDBACK OR COMMENT
            $(document).on("click", ".delete-feedback, .delete-comment", function () {
                var btn = $(this);
                var isFeedback = btn.hasClass("delete-feedback");
                var id = btn.data(isFeedback ? "feedback-id" : "comment-id");
                var url = isFeedback
                    ? '@Url.Action("DeleteFeedback", "Announcement")'
                    : '@Url.Action("DeleteComment", "Announcement")';
                var selector = isFeedback ? `[data-feedback-id='${id}']` : `[data-comment-id='${id}']`;

                if (!confirm(`Are you sure you want to delete this ${isFeedback ? "feedback" : "comment"}?`)) return;

                $.ajax({
                    url: url,
                    type: "POST",
                    data: { id: id },
                    headers: { "RequestVerificationToken": getToken() }
                })
                .done(function (data) {
                    if (data.success) {
                        $(selector).remove();
                    } else {
                        alert(data.message || `Failed to delete ${isFeedback ? "feedback" : "comment"}.`);
                    }
                })
                .fail(() => alert(`Error deleting ${isFeedback ? "feedback" : "comment"}.`));
            });
        });
    </script>
}
